$.noConflict();
jQuery(function(c){var b={treeWidth:0,treeHorizontalRatio:0,nodes:[],labelVisibility:!0,verticalLayout:!0,toggled:!1,graphData:[],numberOfComponents:0,graphIndex:0,graphDepths:[],extraEdges:[],suggestions:[],selected:"",draggedDepth:0,get_graph:function(){return this.graphData[this.graphIndex]},get_depth:function(){return this.graphDepths[this.graphIndex]}},E=function(b){var c=b.reduce(function(b,c){b[c.name]=c;return b},{}),g=[];b.forEach(function(b){var e=c[b.parent];e?(e.children||(e.children=
[])).push(b):g.push(b)});return g},J=function(D){function p(a){function c(a){a.children?(f.push(a.depth),a.children.forEach(c)):a._children?(f.push(a.depth),a._children.forEach(c)):f.push(a.depth)}var f=[];a.children.forEach(c);b.graphDepths[b.graphIndex]=_.max(f)}function g(a){a._children&&(a.children=a._children,a.children.forEach(g),a._children=null)}function k(a){a._children&&(a.children=a._children,a._children=null)}function e(a){a.children&&(a._children=a.children,a._children.forEach(e),a.children=
null)}function N(a){d3.event.preventDefault();100>b.nodes[b.graphIndex]?a._children&&(a.children=a._children,a.children.forEach(g),a._children=null,n(a),q(a)):a._children&&(a.children=a._children,a.children.forEach(k),a._children=null,n(a),q(a))}function w(a,b){h=a;d3.select(b).select(".ghostCircle").attr("pointer-events","none");d3.select(b).select(".node").attr("pointer-events","none");d3.selectAll(".ghostCircle").attr("class","ghostCircle show");d3.select(b).attr("class","node activeDrag");u.selectAll("g.node").sort(function(a,
b){return a.id!==h.id?1:-1});if(1<z.length){var c=s.links(z);u.selectAll("path.link").data(c,function(a){return a.target.id}).remove();u.selectAll("g.node").data(z,function(a){return a.id}).filter(function(a,b){return a.id===h.id?!1:!0}).remove()}}function G(){var a=c("#rightbar2").contents().filter(function(){return 1!==this.nodeType}),F=a.text(),f="Depth of graph: "+b.get_depth()+"/";a.each(function(){this.textContent=this.textContent.replace(F,f)});var a=c("#depthExp"),l=b.get_depth();a.spinner({max:l,
min:1,step:1});a.spinner("value")>l&&a.spinner("value",l)}function C(){var a,b;m&&(a=m.depth,b=m.name);m=null;d3.selectAll(".ghostCircle").attr("class","ghostCircle");d3.select(x).attr("class","node");d3.select(x).select(".ghostCircle").attr("pointer-events","");A();if(null!==h&&"undefined"!==typeof b){a+=1;if(h._children&&null!==h._children){var c=function(a){a._children?(a.depth=a.parent.depth+1,a._children.forEach(c)):a.depth=a.parent.depth+1};h.depth=a;h._children.forEach(c)}else h.depth=a;n(d);
q(d);p(d);G();h=null}B=!1}function L(){var a=c("#rightbar").contents().filter(function(){return 1!==this.nodeType}),F="Graph: "+(b.graphIndex+1)+"/"+b.numberOfComponents,f="Nodes: "+b.nodes[b.graphIndex];a.each(function(){this.textContent=this.textContent===a[0].textContent?this.textContent.replace(a[0].textContent,F):this.textContent.replace(a[1].textContent,f)})}function E(a){function b(a){a.children?(c.push([a.parent.name,a.name]),a.children.forEach(b)):a._children?(c.push([a.parent.name,a.name]),
a._children.forEach(b)):c.push([a.parent.name,a.name])}var c=[];a.children.forEach(b);return JSON.stringify(c)}function J(a,c){var f=document.getElementById("svgform");f.output_format.value=a;f.layout.value=b.verticalLayout?"vertical":"horizontal";if("txt"===a)f.data.value=E(d);else{var l=document.getElementById("visualization");f.data.value=(new XMLSerializer).serializeToString(l)}f.submit();c()}function M(a){if("undefined"!==typeof a.children||"undefined"!==typeof a._children)a.children?(a._children=
a.children,a.children=null,a._children.forEach(e)):(a.children=a._children,a._children=null,a.children.forEach(e));return a}function K(a){a=M(a);n(a);q(a)}function O(){if(!B){var a=d3.select(this);a.select("circle").attr("r",function(){return 15});a.select("text").style({"font-size":"20px"}).attr("dy",function(){return"1em"}).text(function(a){return a.name});a.select(".ghostCircle").attr("r",function(){return 20})}}function P(){var a=d3.select(this);a.select("circle").attr("r",function(){return 6});
a.select("text").style({"font-size":"10px"}).attr("dy",function(){return".35em"}).text(function(a){return b.labelVisibility?a.name:""});a.select(".ghostCircle").attr("r",function(){return 6})}function q(a){var c=y.scale(),f,d=0;b.verticalLayout?(f=-a.x0*c+v/2,d=-a.y0*c+t/4):(f=-a.y0*c+100,d=-a.x0*c+t/2);d3.select("g").transition().duration(750).attr("transform","translate("+f+","+d+")scale("+c+")");y.scale(c);y.translate([f,d])}function n(a){var c=[1],f=[1],l=t,e,h=function(a,b){function d(a){var b=
0,c;for(c=0;c<a.length;c+=1)b+=a[c].name.length;return b}b.children&&0<b.children.length&&(c.length<=a+1&&c.push(0),f.length<=a+1&&f.push(0),c[a+1]+=b.children.length,f[a+1]+=d(b.children),b.children.forEach(function(b){h(a+1,b)}))};h(0,d);var g=_.reduce(c,function(a,b){return a+b},0);if(b.verticalLayout){l=100*c.length;if(b.labelVisibility){e=[];for(g=0;g<c.length;g+=1)e[g]=4*c[g]+7*f[g];e=500>d3.max(e)?500+b.treeWidth:d3.max(e)+b.treeWidth}else e=20*g;b.graphWidth=e;b.graphHeight=l;s=s.size([e,
l]).separation(function(a,c){return b.labelVisibility?a.name.length+c.name.length+5:10})}else e=c.length*(100+g+b.treeHorizontalRatio),l=3*c.length*g,b.graphWidth=e,b.graphHeight=l,s=s.size([e,l]).separation(function(){return 10});var k=s.nodes(d).reverse(),n=s.links(k),p=[];k.forEach(function(a){p.push(a.name)});b.extraEdges.forEach(function(a){_.contains(p,a[0])&&_.contains(p,a[1])&&(a={source:_.findWhere(k,{name:a[0]}),target:_.findWhere(k,{name:a[1]}),added:!0},n.push(a))});k.forEach(function(a){a.y=
b.verticalLayout?100*a.depth:a.depth*(100+b.treeHorizontalRatio)});l=u.selectAll("g.node").data(k,function(a){return a.id||(a.id=++Q)});n.forEach(function(a){a.hasOwnProperty("added")?a.id=a.source.id+a.target.id+parseInt(b.nodes):a.id=a.target.id});e=l.enter().append("g").call(R).attr("class","node").attr("transform",function(){return b.verticalLayout?"translate("+a.x0+","+a.y0+")":"translate("+a.y0+","+a.x0+")"}).on("click",K).on("mouseenter",O).on("mouseleave",P).on("contextmenu",N);e.append("circle").attr("class",
"nodeCircle").attr("r",1E-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}).style("stroke","steelblue").style("stroke-width","1px");e.append("circle").attr("class","ghostCircle").attr("r",30).attr("opacity",0).style("fill","red").attr("pointer-events","mouseover").on("mouseover",function(a){m=a;A()}).on("mouseout",function(a){m=null;A()});b.verticalLayout?e.append("svg:text").attr("y",function(a){return a===D[0]?-10:10}).attr("dy",".35em").attr("text-anchor","middle").text(function(a){return b.labelVisibility?
a.name:""}).style("font-size","10px").style("font-family","sans-serif").style("fill-opacity",1E-6):e.append("svg:text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dx",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).text(function(a){return b.labelVisibility?a.name:""}).style("font-size","12px").style("font-family","sans-serif").style("fill-opacity",1E-6);e=l.transition().duration(750).attr("transform",function(a){return b.verticalLayout?
"translate("+a.x+","+a.y+")":"translate("+a.y+","+a.x+")"});e.select("circle").attr("r",6).style("fill",function(a){return a._children?"#09f":"#fff"});b.verticalLayout?e.select("text").attr("x",function(){return b.toggled?-5:0}).attr("y",function(a){return a===D[0]?-14:14}).attr("dy",".35em").attr("text-anchor","middle").style("fill","#353524").style("fill-opacity",1):e.select("text").attr("y",0).attr("x",function(a){return a.children||a._children?-20:10}).attr("dx",".35em").attr("text-anchor",function(a){return a.children||
a._children?"end":"start"}).style("fill-opacity",1);l=l.exit().transition().duration(750).attr("transform",function(){return"translate("+a.x+","+a.y+")"}).remove();l.select("circle").attr("r",1E-6);l.select("text").style("fill-opacity",1E-6);l=u.selectAll("path.link").data(n,function(a){return a.id});l.enter().insert("path","g").style("fill","none").style("stroke-width","1px").attr("class","link").attr("stroke",function(a){return a.hasOwnProperty("added")?"#88F":"#666"}).attr("stroke-dasharray",function(a){return a.hasOwnProperty("added")?
"0,5 1":"1 0"}).attr("d",function(){var b={x:a.x0,y:a.y0};return H({source:b,target:b})}).attr("marker-end",function(){return"url(#normal)"});l.transition().duration(750).attr("d",H);l.exit().transition().duration(750).attr("d",function(){var b={x:a.x,y:a.y};return H({source:b,target:b})}).remove();k.forEach(function(a){a.x0=a.x;a.y0=a.y})}var r=c("#visualization"),v=r.width(),t=r.height(),Q=0,d,m=null,h=null,B=!1,z,x=null,s=d3.layout.tree().size([v,t]).separation(function(a,b){return a.name.length+
b.name.length+5}),H=d3.svg.diagonal().projection(function(a){return b.verticalLayout?[a.x,a.y]:[a.y,a.x]}),y=d3.behavior.zoom().scaleExtent([.2,2]).on("zoom",function(){u.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}),r=d3.select("svg#visualization").attr("width",v).attr("height",t).attr("class","overlay").call(y),u=r.append("svg:g");r.append("defs").selectAll("marker").data(["normal","added"]).enter().append("marker").attr("id",function(a){return a}).attr("viewBox",
"0 -5 10 10").attr("refX",17).attr("refY",0).attr("markerWidth",7).attr("markerHeight",7).attr("fill","#555").attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");d=D[0];d.x0=v/2;d.y0=t/4;var R=d3.behavior.drag().on("dragstart",function(a){a!=d&&(B=!0,b.draggedDepth=a.depth,z=s.nodes(a),d3.event.sourceEvent.stopPropagation())}).on("drag",function(a){if(a!==d){B&&(x=this,w(a,x),a.children&&e(a));var c=d3.select(this);b.verticalLayout?(a.x0+=d3.event.dx,a.y0+=d3.event.dy,c.attr("transform",
"translate("+a.x0+","+a.y0+")")):(a.x0+=d3.event.dy,a.y0+=d3.event.dx,c.attr("transform","translate("+a.y0+","+a.x0+")"));A()}}).on("dragend",function(a){a!==d&&(x=this,m&&(a=h.parent.children.indexOf(h),-1<a&&h.parent.children.splice(a,1),"undefined"!==typeof m.children||"undefined"!==typeof m._children?m.children?m.children.push(h):(null===m._children&&(m._children=[]),m._children.push(h)):(m.children=[],m.children.push(h))),C())}),A=function(){var a=[];null!==h&&null!==m&&(a=b.verticalLayout?[{source:{x:m.x0,
y:m.y0},target:{x:h.x0,y:h.y0}}]:[{source:{x:m.y0,y:m.x0},target:{x:h.y0,y:h.x0}}]);a=u.selectAll(".templink").data(a);a.enter().append("path").attr("class","templink").attr("d",d3.svg.diagonal()).attr("pointer-events","none");a.attr("d",d3.svg.diagonal());a.exit().remove()},r=c("<p>").textContent="Nodes: "+b.nodes[b.graphIndex],I=c("<p id='spintext'>").textContent="Depth of graph: "+b.get_depth()+" / ",S=c("<p>").textContent="Graph: "+(b.graphIndex+1)+" / "+b.numberOfComponents;c("#rightbar").tooltip().append('<button id="expandTree" title="Increase the space between nodes">').append('<button id="shrinkTree" title="Decrease the space between nodes">').append('<button id="centerRoot" title="Reset view to the root element">').append('<button id="toggleLabels" title="Show/hide node labels">').append('<button id="flipLayout" title="Change between horizontal and vertical tree layout">').append('<button id="changeGraphUp" title="Select the next graph">').append('<button id="changeGraphDown" title="Select the previous graph">').append(S).append("<br>").append(r);
c("#expandTree").button({label:"Expand Tree",icons:{primary:"ui-icon-plus"}});c("#shrinkTree").button({label:"Shrink Tree",icons:{primary:"ui-icon-minus"}});c("#centerRoot").button({label:"Center Root",icons:{primary:"ui-icon-home"}});c("#toggleLabels").button({label:"Toggle Labels",icons:{primary:"ui-icon-tag"}});c("#flipLayout").button({label:"Flip Layout",icons:{primary:"ui-icon-arrowreturnthick-1-e"}});c("#changeGraphUp").button({label:"Next Graph",icons:{primary:"ui-icon-triangle-1-e"}});c("#changeGraphDown").button({label:"Prev. Graph",
icons:{primary:"ui-icon-triangle-1-w"}});c("#rightbar2").tooltip().append(I).append('<input id="depthExp" type="spinner" value="1">').append('<button id="expandSpin" title="Expand the graph to the selected depth">').append('<button id="exportGraph" value="Save as...">');c("#expandSpin").button({label:"Expand"});c("#exportGraph").button({label:"Save as...",icons:{primary:"ui-icon-disk"}});r=c("#searchdiv");r.append('<input type="text" id="query" placeholder="Search for a tag"/>').append('<button id="getResult" value="Get Result" title="Go to the searched tag">');
c("#getResult").button({text:!1,icons:{primary:"ui-icon-search"}});I={delimiter:/(,|;)\s*/,maxHeight:400,width:400,deferRequestBy:0,lookup:b.suggestions[b.graphIndex],onSelect:function(a){b.selected=a}};c("#query").autocomplete(I);r.tooltip({show:{delay:1500}});c("#rightbar").tooltip({show:{delay:1500}});c("#rightbar2").tooltip({show:{delay:1500}});c("#depthExp").spinner({max:b.graphDepths[b.graphIndex],min:1,step:1}).width(20);d3.select("#changeGraphUp").on("click",function(){if(b.graphIndex<b.numberOfComponents-
1){b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.graphIndex+=1;b.toggled=!1;d=b.get_graph()[0];d.x0=v/2;d.y0=t/4;d.children.forEach(e);n(d);q(d);var a=c("#depthExp");a.spinner("value",1);a.spinner({max:b.graphDepths[b.graphIndex],min:1,step:1});G();L();c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}});d3.select("#changeGraphDown").on("click",function(){if(0<b.graphIndex){b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.graphIndex-=1;b.toggled=
!1;d=b.get_graph()[0];d.x0=v/2;d.y0=t/4;d.children.forEach(e);n(d);q(d);var a=c("#depthExp");a.spinner("value",1);a.spinner({max:b.graphDepths[b.graphIndex],min:1,step:1});G();L();c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}});d3.select("#expandSpin").on("click",function(){d.children||(d.children=d._children,d._children=null);(function(){function a(c){c.depth<b&&(c._children?(c.children=c._children,c.children.forEach(a),c._children=null):c._children&&(c.children=c._children,
c.children.forEach(a),c._children=null))}var b=c("#depthExp").spinner("value");d.children.forEach(e);n(d);d.children.forEach(a);n(d);q(d)})()});d3.select("#expandTree").on("click",function(){b.verticalLayout?b.treeWidth+=250:b.treeHorizontalRatio+=50;n(d)});d3.select("#shrinkTree").on("click",function(){b.verticalLayout?b.treeWidth=400<b.treeWidth?b.treeWidth-400:0:b.treeHorizontalRatio=50<b.treeHorizontalRatio?b.treeHorizontalRatio-50:0;n(d)});d3.select("#centerRoot").on("click",function(){y.scale(1).translate([0,
0]);q(d)});d3.select("#toggleLabels").on("click",function(){b.labelVisibility=!b.labelVisibility;d3.selectAll("g.node").select("text").text(function(a){return b.labelVisibility?a.name:""});n(d);q(d)});d3.select("#flipLayout").on("click",function(){b.verticalLayout=!b.verticalLayout;b.toggled=!0;n(d);q(d)});d3.select("#exportGraph").on("click",function(){var a=["PDF","PNG","JPG","SVG","TXT"],b=c('<select id="extSelector" name="extension" />'),d;for(d in a)a.hasOwnProperty(d)&&c("<option />",{value:d,
text:a[d]}).appendTo(b);d=c("#rightbar2");d.append(b);c("#exportGraph").attr("disabled",!0);b=c('<input id="saveAction" type="button" value="Save!" title="Save in the selected format">');d.append(b);d3.select("#saveAction").on("click",function(){var b=a[c("#extSelector").val()].toLowerCase();J(b,function(){c("#saveAction").remove();c("#extSelector").remove();c("#exportGraph").attr("disabled",!1)})})});d3.select("#getResult").on("click",function(){var a=b.selected.value,e=[],f=null,g=function(b){b.children&&
b.children.forEach(g);b.name===a&&(f=b)};d.children.forEach(g);if(!f){var h=function(b){b.children?b.children.forEach(h):b._children&&b._children.forEach(h);if(b.name===a){f=b;var c=function(a){"null"!==a.parent&&a._children&&(e.push(a),c(a.parent))};c(b.parent)}};d.children.forEach(h)}f&&(0<e.length&&(e.reverse(),e.forEach(M),n(d)),q(f));c("#query").val("");b.selected="";console.log(f)});d.children.forEach(e);n(d);q(d)},K=function(b){function c(b){b.children?(g[b.depth]=!0,b.children.forEach(c)):
g[b.depth]=!0}b=b[0];var g={},k,e=0;d3.layout.tree().nodes(b).reverse();b.children.forEach(c);for(k in g)g.hasOwnProperty(k)&&(e+=1);return e};c.ajaxSetup({error:function(b){500===b.status&&(b=c("<p>").textContent="Internal server error.",c("#infobar").append(b))}});var C=String(parseInt(.7*c(window).width())),w=c(window).height()-370;480>w?(c("#visualization").height("480").width(C),c("#rightbar").height("480")):(c("#visualization").height(String(w)).width(C),c("#rightbar").height(String(w)));(function(){c("#fileupload").fileupload({add:function(b,
p){var g=c("#infobar");c("svg#visualization").empty();var k=p.originalFiles[0].name.split("."),k=k[k.length-1].toLowerCase();g.html("");switch(k){case "txt":case "zip":case "cys":case "xgmml":case "xml":p.submit();break;default:k=c("<p>").textContent="Invalid file type!",g.append(k)}},url:"/visualize/data/",crossDomain:!1,paramName:"graph",dataType:"json",done:function(){c("#progress-circle").css("visibility","hidden")}}).on("fileuploadprogressall",function(){c("#progress-circle").css("visibility",
"visible")}).on("fileuploaddone",function(w,p){c("#infobar").html("");c("#rightbar").html("");c("#rightbar2").html("");c("#searchdiv").html("");c("#progress-circle").css("visibility","hidden");b.numberOfComponents=p.result.data.length;b.extraEdges=p.result.edges;if(1<b.numberOfComponents){var g=c("<p>").textContent="Uploaded file contained multiple components("+b.numberOfComponents+"), using the first.";c("#infobar").append(g)}c("#visualization").css("border","1px solid #e0e0e0");b.treeWidth=0;b.treeHorizontalRatio=
0;b.graphData=[];b.graphDepths=[];b.nodes=[];b.graphIndex=0;b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.verticalLayout=!0;b.toggled=!1;b.suggestions=[];for(var k=[],g=function(b){k.push(b.name)},e=0;e<b.numberOfComponents;e+=1)b.graphData.push(E(p.result.data[e])),b.graphDepths.push(K(b.graphData[e])),b.nodes.push(p.result.data[e].length),k=[],p.result.data[e].forEach(g),b.suggestions.push(k);J(b.graphData[0]);c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}).prop("disabled",
!c.support.fileInput).parent().addClass(c.support.fileInput?void 0:"disabled")})()});
