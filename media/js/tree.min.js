$.noConflict();
jQuery(function(c){var b={treeWidth:0,treeHorizontalRatio:0,nodes:[],labelVisibility:!0,verticalLayout:!0,toggled:!1,graphData:[],numberOfComponents:0,graphIndex:0,graphDepths:[],extraEdges:[],suggestions:[],selected:"",draggedDepth:0,get_graph:function(){return this.graphData[this.graphIndex]},get_depth:function(){return this.graphDepths[this.graphIndex]}},F=function(b){var c=b.reduce(function(b,c){b[c.name]=c;return b},{}),h=[];b.forEach(function(b){var g=c[b.parent];g?(g.children||(g.children=
[])).push(b):h.push(b)});return h},L=function(E){function r(a){function c(a){a.children?(f.push(a.depth),a.children.forEach(c)):a._children?(f.push(a.depth),a._children.forEach(c)):f.push(a.depth)}var f=[];a.children.forEach(c);b.graphDepths[b.graphIndex]=_.max(f)}function h(a){a._children&&(a.children=a._children,a.children.forEach(h),a._children=null)}function n(a){a._children&&(a.children=a._children,a._children=null)}function g(a){a.children&&(a._children=a.children,a._children.forEach(g),a.children=
null)}function O(a){d3.event.preventDefault();100>b.nodes[b.graphIndex]?a._children&&(a.children=a._children,a.children.forEach(h),a._children=null,p(a),q(a)):a._children&&(a.children=a._children,a.children.forEach(n),a._children=null,p(a),q(a))}function x(a,b){e=a;d3.select(b).select(".ghostCircle").attr("pointer-events","none");d3.select(b).select(".node").attr("pointer-events","none");d3.selectAll(".ghostCircle").attr("class","ghostCircle show");d3.select(b).attr("class","node activeDrag");v.selectAll("g.node").sort(function(a,
b){return a.id!==e.id?1:-1});if(1<A.length){var c=t.links(A);v.selectAll("path.link").data(c,function(a){return a.target.id}).remove();v.selectAll("g.node").data(A,function(a){return a.id}).filter(function(a,b){return a.id===e.id?!1:!0}).remove()}}function H(){var a=c("#rightbar2").contents().filter(function(){return 1!==this.nodeType}),G=a.text(),f="Depth of graph: "+b.get_depth()+"/";a.each(function(){this.textContent=this.textContent.replace(G,f)});c("#depthExp").spinner({max:b.get_depth(),min:1,
step:1})}function D(){var a,c;l&&(a=l.depth,c=l.name);l=null;d3.selectAll(".ghostCircle").attr("class","ghostCircle");d3.select(y).attr("class","node");d3.select(y).select(".ghostCircle").attr("pointer-events","");B();if(null!==e&&"undefined"!==typeof c){a+=1;var f=a-b.draggedDepth;if(e._children&&null!==e._children){var k=function(a){a._children?(a.depth+=f,a._children.forEach(k)):a.depth+=f};e.depth=a;e._children.forEach(k)}else e.depth=a;p(d);q(d);r(d);H();e=null}C=!1}function N(){var a=c("#rightbar").contents().filter(function(){return 1!==
this.nodeType}),G="Graph: "+(b.graphIndex+1)+"/"+b.numberOfComponents,f="Nodes: "+b.nodes[b.graphIndex];a.each(function(){this.textContent=this.textContent===a[0].textContent?this.textContent.replace(a[0].textContent,G):this.textContent.replace(a[1].textContent,f)})}function F(a){function b(a){a.children?(c.push([a.parent.name,a.name]),a.children.forEach(b)):a._children?(c.push([a.parent.name,a.name]),a._children.forEach(b)):c.push([a.parent.name,a.name])}var c=[];a.children.forEach(b);return JSON.stringify(c)}
function L(a,c){var f=document.getElementById("svgform");f.output_format.value=a;f.layout.value=b.verticalLayout?"vertical":"horizontal";if("txt"===a)f.data.value=F(d);else{var k=document.getElementById("visualization");f.data.value=(new XMLSerializer).serializeToString(k)}f.submit();c()}function I(a){if("undefined"!==typeof a.children||"undefined"!==typeof a._children)a.children?(a._children=a.children,a.children=null,a._children.forEach(g)):(a.children=a._children,a._children=null,a.children.forEach(g));
return a}function M(a){a=I(a);p(a);q(a)}function P(){if(!C){var a=d3.select(this);a.select("circle").attr("r",function(){return 15});a.select("text").style({"font-size":"20px"}).attr("dy",function(){return"1em"}).text(function(a){return a.name});a.select(".ghostCircle").attr("r",function(){return 20})}}function Q(){var a=d3.select(this);a.select("circle").attr("r",function(){return 6});a.select("text").style({"font-size":"10px"}).attr("dy",function(){return".35em"}).text(function(a){return b.labelVisibility?
a.name:""});a.select(".ghostCircle").attr("r",function(){return 6})}function q(a){var c=z.scale(),f,d=0;b.verticalLayout?(f=-a.x0*c+w/2,d=-a.y0*c+u/4):(f=-a.y0*c+100,d=-a.x0*c+u/2);d3.select("g").transition().duration(750).attr("transform","translate("+f+","+d+")scale("+c+")");z.scale(c);z.translate([f,d])}function p(a){var c=[1],f=[1],k=u,m,g=function(a,b){function d(a){var b=0,c;for(c=0;c<a.length;c+=1)b+=a[c].name.length;return b}b.children&&0<b.children.length&&(c.length<=a+1&&c.push(0),f.length<=
a+1&&f.push(0),c[a+1]+=b.children.length,f[a+1]+=d(b.children),b.children.forEach(function(b){g(a+1,b)}))};g(0,d);var e=_.reduce(c,function(a,b){return a+b},0);if(b.verticalLayout){k=100*c.length;if(b.labelVisibility){m=[];for(e=0;e<c.length;e+=1)m[e]=4*c[e]+7*f[e];m=500>d3.max(m)?500+b.treeWidth:d3.max(m)+b.treeWidth}else m=20*e;b.graphWidth=m;b.graphHeight=k;t=t.size([m,k]).separation(function(a,c){return b.labelVisibility?a.name.length+c.name.length+5:10})}else m=c.length*(100+e+b.treeHorizontalRatio),
k=3*c.length*e,b.graphWidth=m,b.graphHeight=k,t=t.size([m,k]).separation(function(){return 10});var h=t.nodes(d).reverse(),n=t.links(h),p=[];h.forEach(function(a){p.push(a.name)});b.extraEdges.forEach(function(a){_.contains(p,a[0])&&_.contains(p,a[1])&&(a={source:_.findWhere(h,{name:a[0]}),target:_.findWhere(h,{name:a[1]}),added:!0},n.push(a))});h.forEach(function(a){a.y=b.verticalLayout?100*a.depth:a.depth*(100+b.treeHorizontalRatio)});k=v.selectAll("g.node").data(h,function(a){return a.id||(a.id=
++R)});n.forEach(function(a){a.hasOwnProperty("added")?a.id=a.source.id+a.target.id+parseInt(b.nodes):a.id=a.target.id});m=k.enter().append("g").call(S).attr("class","node").attr("transform",function(){return b.verticalLayout?"translate("+a.x0+","+a.y0+")":"translate("+a.y0+","+a.x0+")"}).on("click",M).on("mouseenter",P).on("mouseleave",Q).on("contextmenu",O);m.append("circle").attr("class","nodeCircle").attr("r",1E-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}).style("stroke",
"steelblue").style("stroke-width","1px");m.append("circle").attr("class","ghostCircle").attr("r",30).attr("opacity",0).style("fill","red").attr("pointer-events","mouseover").on("mouseover",function(a){l=a;B()}).on("mouseout",function(a){l=null;B()});b.verticalLayout?m.append("svg:text").attr("y",function(a){return a===E[0]?-10:10}).attr("dy",".35em").attr("text-anchor","middle").text(function(a){return b.labelVisibility?a.name:""}).style("font-size","10px").style("font-family","sans-serif").style("fill-opacity",
1E-6):m.append("svg:text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dx",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).text(function(a){return b.labelVisibility?a.name:""}).style("font-size","12px").style("font-family","sans-serif").style("fill-opacity",1E-6);m=k.transition().duration(750).attr("transform",function(a){return b.verticalLayout?"translate("+a.x+","+a.y+")":"translate("+a.y+","+a.x+")"});m.select("circle").attr("r",6).style("fill",
function(a){return a._children?"#09f":"#fff"});b.verticalLayout?m.select("text").attr("x",function(){return b.toggled?-5:0}).attr("y",function(a){return a===E[0]?-14:14}).attr("dy",".35em").attr("text-anchor","middle").style("fill","#353524").style("fill-opacity",1):m.select("text").attr("y",0).attr("x",function(a){return a.children||a._children?-20:10}).attr("dx",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).style("fill-opacity",1);k=k.exit().transition().duration(750).attr("transform",
function(){return"translate("+a.x+","+a.y+")"}).remove();k.select("circle").attr("r",1E-6);k.select("text").style("fill-opacity",1E-6);k=v.selectAll("path.link").data(n,function(a){return a.id});k.enter().insert("path","g").style("fill","none").style("stroke-width","1px").attr("class","link").attr("stroke",function(a){return a.hasOwnProperty("added")?"#88F":"#666"}).attr("stroke-dasharray",function(a){return a.hasOwnProperty("added")?"0,5 1":"1 0"}).attr("d",function(){var b={x:a.x0,y:a.y0};return J({source:b,
target:b})}).attr("marker-end",function(){return"url(#normal)"});k.transition().duration(750).attr("d",J);k.exit().transition().duration(750).attr("d",function(){var b={x:a.x,y:a.y};return J({source:b,target:b})}).remove();h.forEach(function(a){a.x0=a.x;a.y0=a.y})}var s=c("#visualization"),w=s.width(),u=s.height(),R=0,d,l=null,e=null,C=!1,A,y=null,t=d3.layout.tree().size([w,u]).separation(function(a,b){return a.name.length+b.name.length+5}),J=d3.svg.diagonal().projection(function(a){return b.verticalLayout?
[a.x,a.y]:[a.y,a.x]}),z=d3.behavior.zoom().scaleExtent([.2,2]).on("zoom",function(){v.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}),s=d3.select("svg#visualization").attr("width",w).attr("height",u).attr("class","overlay").call(z),v=s.append("svg:g");s.append("defs").selectAll("marker").data(["normal","added"]).enter().append("marker").attr("id",function(a){return a}).attr("viewBox","0 -5 10 10").attr("refX",17).attr("refY",0).attr("markerWidth",7).attr("markerHeight",
7).attr("fill","#555").attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");d=E[0];d.x0=w/2;d.y0=u/4;var S=d3.behavior.drag().on("dragstart",function(a){a!=d&&(a.children&&I(a),C=!0,b.draggedDepth=a.depth,A=t.nodes(a),d3.event.sourceEvent.stopPropagation())}).on("drag",function(a){if(a!==d){C&&(y=this,x(a,y));var c=d3.select(this);b.verticalLayout?(a.x0+=d3.event.dx,a.y0+=d3.event.dy,c.attr("transform","translate("+a.x0+","+a.y0+")")):(a.x0+=d3.event.dy,a.y0+=d3.event.dx,c.attr("transform",
"translate("+a.y0+","+a.x0+")"));B()}}).on("dragend",function(a){a!==d&&(y=this,l&&(a=e.parent.children.indexOf(e),-1<a&&e.parent.children.splice(a,1),"undefined"!==typeof l.children||"undefined"!==typeof l._children?l.children?l.children.push(e):(null===l._children&&(l._children=[]),l._children.push(e)):(l.children=[],l.children.push(e))),D())}),B=function(){var a=[];null!==e&&null!==l&&(a=b.verticalLayout?[{source:{x:l.x0,y:l.y0},target:{x:e.x0,y:e.y0}}]:[{source:{x:l.y0,y:l.x0},target:{x:e.y0,
y:e.x0}}]);a=v.selectAll(".templink").data(a);a.enter().append("path").attr("class","templink").attr("d",d3.svg.diagonal()).attr("pointer-events","none");a.attr("d",d3.svg.diagonal());a.exit().remove()},s=c("<p>").textContent="Nodes: "+b.nodes[b.graphIndex],K=c("<p id='spintext'>").textContent="Depth of graph: "+b.get_depth()+" / ",T=c("<p>").textContent="Graph: "+(b.graphIndex+1)+" / "+b.numberOfComponents;c("#rightbar").tooltip().append('<button id="expandTree" title="Increase the space between nodes">').append('<button id="shrinkTree" title="Decrease the space between nodes">').append('<button id="centerRoot" title="Reset view to the root element">').append('<button id="toggleLabels" title="Show/hide node labels">').append('<button id="flipLayout" title="Change between horizontal and vertical tree layout">').append('<button id="changeGraphUp" title="Select the next graph">').append('<button id="changeGraphDown" title="Select the previous graph">').append(T).append("<br>").append(s);
c("#expandTree").button({label:"Expand Tree",icons:{primary:"ui-icon-plus"}});c("#shrinkTree").button({label:"Shrink Tree",icons:{primary:"ui-icon-minus"}});c("#centerRoot").button({label:"Center Root",icons:{primary:"ui-icon-home"}});c("#toggleLabels").button({label:"Toggle Labels",icons:{primary:"ui-icon-tag"}});c("#flipLayout").button({label:"Flip Layout",icons:{primary:"ui-icon-arrowreturnthick-1-e"}});c("#changeGraphUp").button({label:"Next Graph",icons:{primary:"ui-icon-triangle-1-e"}});c("#changeGraphDown").button({label:"Prev. Graph",
icons:{primary:"ui-icon-triangle-1-w"}});c("#rightbar2").tooltip().append(K).append('<input id="depthExp" type="spinner" value="1">').append('<button id="expandSpin" title="Expand the graph to the selected depth">').append('<button id="exportGraph" value="Save as...">');c("#expandSpin").button({label:"Expand"});c("#exportGraph").button({label:"Save as...",icons:{primary:"ui-icon-disk"}});s=c("#searchdiv");s.append('<input type="text" id="query" placeholder="Search for a tag"/>').append('<button id="getResult" value="Get Result" title="Go to the searched tag">');
c("#getResult").button({text:!1,icons:{primary:"ui-icon-search"}});K={delimiter:/(,|;)\s*/,maxHeight:400,width:400,deferRequestBy:0,lookup:b.suggestions[b.graphIndex],onSelect:function(a){b.selected=a}};c("#query").autocomplete(K);s.tooltip({show:{delay:1500}});c("#rightbar").tooltip({show:{delay:1500}});c("#rightbar2").tooltip({show:{delay:1500}});c("#depthExp").spinner({max:b.graphDepths[b.graphIndex],min:1,step:1}).width(20);d3.select("#changeGraphUp").on("click",function(){if(b.graphIndex<b.numberOfComponents-
1){b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.graphIndex+=1;b.toggled=!1;d=b.get_graph()[0];d.x0=w/2;d.y0=u/4;d.children.forEach(g);p(d);q(d);var a=c("#depthExp");a.spinner("value",1);a.spinner({max:b.graphDepths[b.graphIndex],min:1,step:1});H();N();c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}});d3.select("#changeGraphDown").on("click",function(){if(0<b.graphIndex){b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.graphIndex-=1;b.toggled=
!1;d=b.get_graph()[0];d.x0=w/2;d.y0=u/4;d.children.forEach(g);p(d);q(d);var a=c("#depthExp");a.spinner("value",1);a.spinner({max:b.graphDepths[b.graphIndex],min:1,step:1});H();N();c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}});d3.select("#expandSpin").on("click",function(){d.children||(d.children=d._children,d._children=null);(function(){function a(c){c.depth<b&&(c._children?(c.children=c._children,c.children.forEach(a),c._children=null):c._children&&(c.children=c._children,
c.children.forEach(a),c._children=null))}var b=c("#depthExp").spinner("value");d.children.forEach(g);p(d);d.children.forEach(a);p(d);q(d)})()});d3.select("#expandTree").on("click",function(){b.verticalLayout?b.treeWidth+=250:b.treeHorizontalRatio+=50;p(d)});d3.select("#shrinkTree").on("click",function(){b.verticalLayout?b.treeWidth=400<b.treeWidth?b.treeWidth-400:0:b.treeHorizontalRatio=50<b.treeHorizontalRatio?b.treeHorizontalRatio-50:0;p(d)});d3.select("#centerRoot").on("click",function(){z.scale(1).translate([0,
0]);q(d)});d3.select("#toggleLabels").on("click",function(){b.labelVisibility=!b.labelVisibility;d3.selectAll("g.node").select("text").text(function(a){return b.labelVisibility?a.name:""});p(d);q(d)});d3.select("#flipLayout").on("click",function(){b.verticalLayout=!b.verticalLayout;b.toggled=!0;p(d);q(d)});d3.select("#exportGraph").on("click",function(){var a=["PDF","PNG","JPG","SVG","TXT"],b=c('<select id="extSelector" name="extension" />'),d;for(d in a)a.hasOwnProperty(d)&&c("<option />",{value:d,
text:a[d]}).appendTo(b);d=c("#rightbar2");d.append(b);c("#exportGraph").attr("disabled",!0);b=c('<input id="saveAction" type="button" value="Save!" title="Save in the selected format">');d.append(b);d3.select("#saveAction").on("click",function(){var b=a[c("#extSelector").val()].toLowerCase();L(b,function(){c("#saveAction").remove();c("#extSelector").remove();c("#exportGraph").attr("disabled",!1)})})});d3.select("#getResult").on("click",function(){var a=b.selected.value,e=[],f=null,g=function(b){b.children&&
b.children.forEach(g);b.name===a&&(f=b)};d.children.forEach(g);if(!f){var h=function(b){b.children?b.children.forEach(h):b._children&&b._children.forEach(h);if(b.name===a){f=b;var c=function(a){"null"!==a.parent&&a._children&&(e.push(a),c(a.parent))};c(b.parent)}};d.children.forEach(h)}f&&(0<e.length&&(e.reverse(),e.forEach(I),p(d)),q(f));c("#query").val("");b.selected="";console.log(f)});d.children.forEach(g);p(d);q(d)},M=function(b){function c(b){b.children?(h[b.depth]=!0,b.children.forEach(c)):
h[b.depth]=!0}b=b[0];var h={},n,g=0;d3.layout.tree().nodes(b).reverse();b.children.forEach(c);for(n in h)h.hasOwnProperty(n)&&(g+=1);return g};c.ajaxSetup({error:function(b){500===b.status&&(b=c("<p>").textContent="Internal server error.",c("#infobar").append(b))}});var D=String(parseInt(.7*c(window).width())),x=c(window).height()-370;480>x?(c("#visualization").height("480").width(D),c("#rightbar").height("480")):(c("#visualization").height(String(x)).width(D),c("#rightbar").height(String(x)));(function(){c("#fileupload").fileupload({add:function(b,
r){var h=c("#infobar");c("svg#visualization").empty();var n=r.originalFiles[0].name.split("."),n=n[n.length-1].toLowerCase();h.html("");switch(n){case "txt":case "zip":case "cys":case "xgmml":case "xml":r.submit();break;default:n=c("<p>").textContent="Invalid file type!",h.append(n)}},url:"/visualize/data/",crossDomain:!1,paramName:"graph",dataType:"json",done:function(){c("#progress-circle").css("visibility","hidden")}}).on("fileuploadprogressall",function(){c("#progress-circle").css("visibility",
"visible")}).on("fileuploaddone",function(x,r){c("#infobar").html("");c("#rightbar").html("");c("#rightbar2").html("");c("#searchdiv").html("");c("#progress-circle").css("visibility","hidden");b.numberOfComponents=r.result.data.length;b.extraEdges=r.result.edges;if(1<b.numberOfComponents){var h=c("<p>").textContent="Uploaded file contained multiple graphs("+b.numberOfComponents+"), using the first.";c("#infobar").append(h)}c("#visualization").css("border","1px solid #e0e0e0");b.treeWidth=0;b.treeHorizontalRatio=
0;b.graphData=[];b.graphDepths=[];b.nodes=[];b.graphIndex=0;b.treeWidth=0;b.treeHorizontalRatio=0;b.labelVisibility=!0;b.verticalLayout=!0;b.toggled=!1;b.suggestions=[];for(var n=[],h=function(b){n.push(b.name)},g=0;g<b.numberOfComponents;g+=1)b.graphData.push(F(r.result.data[g])),b.graphDepths.push(M(b.graphData[g])),b.nodes.push(r.result.data[g].length),n=[],r.result.data[g].forEach(h),b.suggestions.push(n);L(b.graphData[0]);c("#query").autocomplete().setOptions({lookup:b.suggestions[b.graphIndex]})}).prop("disabled",
!c.support.fileInput).parent().addClass(c.support.fileInput?void 0:"disabled")})()});
